
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‹ç­æ—¶é—´ç®¡ç†</title>
    <meta name="description" content="é«˜æ•ˆçš„ä¸‹ç­æ—¶é—´ä¸åŠ ç­ç®¡ç†å·¥å…·ï¼Œæ”¯æŒæ‰“å¡ã€ç»Ÿè®¡ã€Google Apps Script äº‘åŒæ­¥ã€‚">
    <meta name="keywords" content="ä¸‹ç­,åŠ ç­,æ‰“å¡,æ—¶é—´ç®¡ç†,Google Apps Script,è€ƒå‹¤,åŒæ­¥">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle fill='%23667eea' cx='50' cy='50' r='48'/%3E%3Ctext x='50' y='60' font-size='48' text-anchor='middle' fill='white'%3E%E6%97%B6%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .app-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 600px;
            position: relative;
            cursor: move;
            user-select: none;
        }

        .app-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .current-time {
            font-size: 1.2em;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .status-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            color: white;
            text-align: center;
            transform: perspective(1000px) rotateX(2deg);
            transition: transform 0.3s ease;
        }

        .status-card:hover {
            transform: perspective(1000px) rotateX(0deg) translateY(-5px);
        }

        .status-title {
            font-size: 1.1em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .status-time {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-subtitle {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(240, 147, 251, 0.4);
        }

        .settings-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-title {
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .history-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            animation: slideIn 0.3s ease;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 10000;
        }

        .notification.success {
            background: #2ecc71;
        }

        .notification.warning {
            background: #f39c12;
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.info {
            background: #3498db;
        }

        .notification.show {
            transform: translateX(0);
        }

        .synced {
            color: #2ecc71;
            font-weight: bold;
        }

        .pending {
            color: #f39c12;
            font-weight: bold;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .drag-handle {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            cursor: move;
            opacity: 0.3;
        }

        .drag-handle::before,
        .drag-handle::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: #999;
            border-radius: 50%;
        }

        .drag-handle::before {
            top: 2px;
            left: 2px;
            box-shadow: 6px 0 0 #999, 12px 0 0 #999, 0 6px 0 #999, 6px 6px 0 #999, 12px 6px 0 #999, 0 12px 0 #999, 6px 12px 0 #999, 12px 12px 0 #999;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="app-container" id="appContainer">
        <div class="drag-handle"></div>
        
        <div class="header">
            <h1>ä¸‹ç­æ—¶é—´ç®¡ç†</h1>
            <div class="current-time" id="currentTime"></div>
        </div>

        <div class="status-card">
            <div class="status-title">ä»Šæ—¥é¢„è®¡ä¸‹ç­æ—¶é—´</div>
            <div class="status-time" id="expectedTime">18:00</div>
            <div class="status-subtitle" id="statusText">å‡†æ—¶ä¸‹ç­</div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="monthlyOvertime">0</div>
                <div class="stat-label">æœ¬æœˆå·²åŠ ç­(å°æ—¶)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="remainingOvertime">29</div>
                <div class="stat-label">å‰©ä½™åŠ ç­(å°æ—¶)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="averageOffTime">18:00</div>
                <div class="stat-label">æœ¬æœˆå¹³å‡ä¸‹ç­æ—¶é—´</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="workDaysLeft">0</div>
                <div class="stat-label">å‰©ä½™å·¥ä½œæ—¥</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="clockOut()">ä¸‹ç­æ‰“å¡</button>
            <button class="btn btn-secondary" onclick="toggleSettings()">è®¾ç½®</button>
            <button class="btn btn-secondary" onclick="refreshData()" title="åˆ·æ–°æ•°æ®">ğŸ”„</button>
            <button class="btn btn-secondary" onclick="tracker.toggleDebugMode()" title="åˆ‡æ¢è°ƒè¯•æ¨¡å¼">ğŸ</button>
        </div>

        <div class="settings-section" id="settingsSection" style="display: none;">
            <div class="settings-title">è®¾ç½®</div>
            <div class="input-group">
                <label>Google Apps Script Web App URL</label>
                <input type="url" id="gasUrl" placeholder="https://script.google.com/macros/s/AKfycbyF-eivnhfBwHssjJHdIc7UoU3-1ceNipWBSlM3XufPIQlIbb89S1MeKah8LVTpbBjJtw/exec">
            </div>
            <div class="input-group">
                <label>æ­£å¸¸ä¸‹ç­æ—¶é—´</label>
                <input type="time" id="normalOffTime" value="18:00">
            </div>
            <div class="input-group">
                <label>æœˆåº¦åŠ ç­ç›®æ ‡(å°æ—¶)</label>
                <input type="number" id="monthlyTarget" value="29" min="0" max="100">
            </div>
            <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
            <button class="btn btn-secondary" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
        </div>

        <div class="history-section">
            <div class="settings-title">æœ€è¿‘æ‰“å¡è®°å½•</div>
            <div id="historyList">
                <!-- å†å²è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <div class="debug-info" id="debugInfo" style="display: none;">
            <!-- è°ƒè¯•ä¿¡æ¯ -->
        </div>
    </div>

    <footer style="text-align:center;color:#aaa;font-size:0.95em;margin-top:18px;">
        <span>Â© 2025 ä¸‹ç­æ—¶é—´ç®¡ç† | <a href="https://github.com/shigobo/My-OffDuty-App" target="_blank" style="color:#764ba2;text-decoration:none;">GitHub</a> | <a href="javascript:void(0)" onclick="alert('å¦‚éœ€å¸®åŠ©è¯·è”ç³»å¼€å‘è€… shigobo@protonmail.com')" style="color:#764ba2;text-decoration:none;">å…³äº/å¸®åŠ©</a></span>
    </footer>

    <div class="notification" id="notification"></div>

    <script>


  function getISODateString(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

        class OvertimeTracker {
            constructor() {
                this.normalOffTime = '18:00';
                this.monthlyTarget = 29;
                this.workHistory = JSON.parse(localStorage.getItem('workHistory') || '[]');
                this.gasUrl = localStorage.getItem('gasUrl') || '';
                this.isDragging = false;
                this.dragOffset = { x: 0, y: 0 };
                this.serverStats = null;
                this.debugMode = false; // è®¾ç½®ä¸ºtrueå¯ç”¨è°ƒè¯•æ¨¡å¼
                
                this.initDragAndDrop();
                this.startClock();
                this.loadSettings();
                this.loadFromServer();
            }

            debug(message, data = null) {
                if (this.debugMode) {
                    console.log('[DEBUG]', message, data);
                    const debugInfo = document.getElementById('debugInfo');
                    if (debugInfo) {
                        debugInfo.style.display = 'block';
                        const timestamp = new Date().toLocaleTimeString();
                        debugInfo.innerHTML += `[${timestamp}] ${message}${data ? ': ' + JSON.stringify(data, null, 2) : ''}\n`;
                        debugInfo.scrollTop = debugInfo.scrollHeight;
                    }
                }
            }

            initDragAndDrop() {
                const container = document.getElementById('appContainer');
                let startX, startY, initialX, initialY;

                container.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.drag-handle') || e.target === container) {
                        this.isDragging = true;
                        startX = e.clientX;
                        startY = e.clientY;
                        const rect = container.getBoundingClientRect();
                        initialX = rect.left;
                        initialY = rect.top;
                        
                        container.style.position = 'fixed';
                        container.style.left = initialX + 'px';
                        container.style.top = initialY + 'px';
                        container.style.zIndex = '9999';
                        container.style.cursor = 'grabbing';
                        
                        e.preventDefault();
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (this.isDragging) {
                        const deltaX = e.clientX - startX;
                        const deltaY = e.clientY - startY;
                        
                        container.style.left = (initialX + deltaX) + 'px';
                        container.style.top = (initialY + deltaY) + 'px';
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (this.isDragging) {
                        this.isDragging = false;
                        container.style.cursor = 'move';
                    }
                });
            }
  async fetchApi(url, options = {}) {
    try {
        // å¯¹äº Google Apps Scriptï¼Œä½¿ç”¨ no-cors æ¨¡å¼å¤„ç† GET è¯·æ±‚
        const isGetRequest = !options.method || options.method.toUpperCase() === 'GET';
        
        const fetchOptions = {
            ...options,
            mode: isGetRequest ? 'no-cors' : 'cors',
            credentials: 'omit', // ä¸å‘é€å‡­æ®
            cache: 'no-cache'
        };
        
        this.debug("å‘èµ·è¯·æ±‚", {url, options: fetchOptions});
        
        const response = await fetch(url, fetchOptions);

        // å¯¹äº no-cors æ¨¡å¼ï¼Œæˆ‘ä»¬æ— æ³•è¯»å–å“åº”å†…å®¹
        if (fetchOptions.mode === 'no-cors') {
            // å¯¹äº GET è¯·æ±‚ï¼Œæˆ‘ä»¬å‡è®¾è¯·æ±‚æˆåŠŸäº†
            // ä½†å®é™…ä¸Šæˆ‘ä»¬æ— æ³•è·å–å“åº”æ•°æ®
            this.debug("no-cors æ¨¡å¼è¯·æ±‚å®Œæˆï¼Œä½†æ— æ³•è¯»å–å“åº”");
            return { status: 'success', message: 'Request sent but response unavailable in no-cors mode' };
        }

        if (!response.ok) {
            throw new Error(`HTTPè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        this.debug("è¯·æ±‚æˆåŠŸï¼Œè¿”å›æ•°æ®", data);
        return data;

    } catch (error) {
        this.debug("è¯·æ±‚å¤±è´¥", error);
        throw error;
    }
}
async loadFromServer() {
    if (!this.gasUrl) {
        this.debug('æœªé…ç½®æœåŠ¡å™¨URLï¼Œè·³è¿‡æœåŠ¡å™¨æ•°æ®åŠ è½½');
        this.updateDisplay();
        return;
    }

    this.debug('å¼€å§‹ä»æœåŠ¡å™¨åŠ è½½æ•°æ®...');
    this.showNotification('æ­£åœ¨åŠ è½½æ•°æ®...', 'info');

    // å°è¯•å¤šç§æ–¹æ³•è·å–æ•°æ®
    const methods = [
        () => this.fetchWithCORS(),
        () => this.fetchWithJSONP(),
        () => this.fetchWithProxy(),
        () => this.fetchWithImage()
    ];

    let lastError;
    
    for (let i = 0; i < methods.length; i++) {
        try {
            this.debug(`å°è¯•æ–¹æ³• ${i + 1}/${methods.length}`);
            const data = await methods[i]();
            
            if (data !== null && data !== undefined) {
                this.debug('æˆåŠŸè·å–æ•°æ®', data);
                await this.processServerData(data);
                this.showNotification('æ•°æ®åŒæ­¥æˆåŠŸï¼', 'success');
                return;
            } else {
                this.debug(`æ–¹æ³• ${i + 1} è¿”å›null/undefined`);
            }
        } catch (error) {
            this.debug(`æ–¹æ³• ${i + 1} å¤±è´¥:`, error.message);
            lastError = error;
        }
    }

    // å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥äº†
    this.debug('æ‰€æœ‰æ•°æ®è·å–æ–¹æ³•éƒ½å¤±è´¥äº†ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
    this.serverStats = null; // ç¡®ä¿ä½¿ç”¨æœ¬åœ°è®¡ç®—
    this.updateDisplay();
    this.showNotification('æ— æ³•è¿æ¥æœåŠ¡å™¨ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®', 'warning');
}

async fetchWithJSONP() {
    this.debug('å°è¯• JSONP è¯·æ±‚');
    
    return new Promise((resolve, reject) => {
        const callbackName = 'gas_callback_' + Date.now();
        const script = document.createElement('script');
        
        const timeout = setTimeout(() => {
            cleanup();
            reject(new Error('JSONP è¶…æ—¶'));
        }, 15000); // 15ç§’è¶…æ—¶

        function cleanup() {
            if (script.parentNode) {
                script.parentNode.removeChild(script);
            }
            if (window[callbackName]) {
                delete window[callbackName];
            }
            clearTimeout(timeout);
        }

        window[callbackName] = function(data) {
            cleanup();
            resolve(data);
        };

        script.onerror = function(e) {
            cleanup();
            reject(new Error('JSONP è„šæœ¬åŠ è½½å¤±è´¥'));
        };

        // æ„å»º JSONP URLï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®
        const separator = this.gasUrl.includes('?') ? '&' : '?';
        const jsonpUrl = `${this.gasUrl}${separator}callback=${callbackName}&format=jsonp&_=${Date.now()}`;
        
        script.src = jsonpUrl;
        this.debug('JSONP URL:', jsonpUrl);
        
        document.head.appendChild(script);
    });
}// åœ¨ OvertimeTracker ç±»ä¸­æ·»åŠ è¿™äº›ç¼ºå¤±çš„æ–¹æ³•

async fetchWithCORS() {
    this.debug('å°è¯• CORS è¯·æ±‚');
    
    try {
        const response = await fetch(this.gasUrl + '?action=getStats&_=' + Date.now(), {
            method: 'GET',
            mode: 'cors',
            credentials: 'omit',
            cache: 'no-cache',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTPé”™è¯¯: ${response.status}`);
        }

        const data = await response.json();
        this.debug('CORS è¯·æ±‚æˆåŠŸ', data);
        return data;
    } catch (error) {
        this.debug('CORS è¯·æ±‚å¤±è´¥', error);
        throw error;
    }
}

// è¿˜éœ€è¦æ·»åŠ å¤„ç†æœåŠ¡å™¨æ•°æ®çš„æ–¹æ³•
async processServerData(data) {
    this.debug('å¤„ç†æœåŠ¡å™¨æ•°æ®', data);
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç©ºå¯¹è±¡æˆ–æ— æ•ˆæ•°æ®
    if (!data || Object.keys(data).length === 0) {
        this.debug('æœåŠ¡å™¨è¿”å›ç©ºæ•°æ®ï¼Œä½¿ç”¨æœ¬åœ°è®¡ç®—');
        this.serverStats = null; // æ¸…é™¤æœåŠ¡å™¨ç»Ÿè®¡ï¼Œå¼ºåˆ¶ä½¿ç”¨æœ¬åœ°è®¡ç®—
        this.updateDisplay();
        return;
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
    if (data.error) {
        this.debug('æœåŠ¡å™¨è¿”å›é”™è¯¯', data.error);
        throw new Error(data.error + (data.details ? ': ' + data.details : ''));
    }

    try {
        // å¤„ç†ç»Ÿè®¡æ•°æ®
        if (data.stats) {
            this.serverStats = data.stats;
            this.debug('æ›´æ–°æœåŠ¡å™¨ç»Ÿè®¡', this.serverStats);
        } else {
            this.debug('æœåŠ¡å™¨æ•°æ®ä¸­æ²¡æœ‰statså­—æ®µ');
            this.serverStats = null;
        }

        // å¤„ç†å†å²è®°å½•
        if (data.history && Array.isArray(data.history) && data.history.length > 0) {
            this.mergeServerHistory(data.history);
            this.debug('åˆå¹¶äº†æœåŠ¡å™¨å†å²è®°å½•', data.history.length + 'æ¡');
        } else {
            this.debug('æ²¡æœ‰æœåŠ¡å™¨å†å²è®°å½•å¯åˆå¹¶');
        }

        // æ›´æ–°æ˜¾ç¤º
        this.updateDisplay();
        
    } catch (error) {
        this.debug('å¤„ç†æœåŠ¡å™¨æ•°æ®æ—¶å‡ºé”™', error);
        throw error;
    }
}
toggleDebugMode() {
    this.debugMode = !this.debugMode;
    const debugInfo = document.getElementById('debugInfo');
    if (debugInfo) {
        debugInfo.style.display = this.debugMode ? 'block' : 'none';
        if (this.debugMode) {
            debugInfo.innerHTML = '=== è°ƒè¯•æ¨¡å¼å·²å¼€å¯ ===\n';
        }
    }
    this.showNotification(`è°ƒè¯•æ¨¡å¼å·²${this.debugMode ? 'å¼€å¯' : 'å…³é—­'}`, 'info');
}

// æ‰‹åŠ¨è§¦å‘æ•°æ®åŠ è½½ï¼ˆç”¨äºæµ‹è¯•ï¼‰
async manualRefresh() {
    this.showNotification('æ‰‹åŠ¨åˆ·æ–°æ•°æ®...', 'info');
    await this.loadFromServer();
}
mergeServerHistory(serverHistory) {
    this.debug('åˆå¹¶æœåŠ¡å™¨å†å²è®°å½•', serverHistory);

    const serverRecords = serverHistory.map(item => {
        // æ ¹æ®å®é™…çš„å­—æ®µåæå–æ•°æ®
        const dateField = item.date || item.Date;
        
        // ä¿®å¤ï¼šæ·»åŠ æ­£ç¡®çš„å­—æ®µåæ˜ å°„
        const checkOutTime = item.time || item.checkOutTime || item.CheckOut || item.checkOut;
        const overtimeHours = item.overtime || item.overtimeHours || item.OvertimeHours;

        if (!dateField) {
            this.debug('è·³è¿‡æ— æ•ˆè®°å½•ï¼ˆç¼ºå°‘æ—¥æœŸï¼‰', item);
            return null;
        }

        // æå–ä¸‹ç­æ—¶é—´ - å¤„ç†ISOæ ¼å¼çš„UTCæ—¶é—´
        let timeString = '18:00'; // é»˜è®¤æ—¶é—´
        
        if (checkOutTime && typeof checkOutTime === 'string') {
            if (checkOutTime.includes('T') && checkOutTime.includes('Z')) {
                // ISOæ ¼å¼çš„UTCæ—¶é—´ï¼Œéœ€è¦è½¬æ¢ä¸ºæ—¥æœ¬æ—¶é—´
                try {
                    const utcDate = new Date(checkOutTime);
                    // è½¬æ¢ä¸ºæ—¥æœ¬æ—¶é—´ (UTC+9)
                    const japanDate = new Date(utcDate.getTime() + 9 * 60 * 60 * 1000);
                    timeString = japanDate.toTimeString().slice(0, 5);
                    this.debug('UTCæ—¶é—´è½¬æ¢ä¸ºæ—¥æœ¬æ—¶é—´', {
                        åŸå§‹UTC: checkOutTime,
                        è½¬æ¢å: timeString,
                        æ—¥æœ¬å®Œæ•´æ—¶é—´: japanDate.toISOString()
                    });
                } catch (error) {
                    this.debug('æ—¶é—´è½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ—¶é—´', { åŸå§‹æ—¶é—´: checkOutTime, é”™è¯¯: error });
                }
            } else if (checkOutTime.includes(':')) {
                // å¦‚æœæ˜¯ HH:MM:SS æ ¼å¼ï¼Œæˆªå–å‰5ä½å¾—åˆ° HH:MM
                // æˆ–è€…ç›´æ¥æ˜¯ HH:MM æ ¼å¼
                timeString = checkOutTime.slice(0, 5);
                this.debug('ç›´æ¥ä½¿ç”¨æ—¶é—´å­—ç¬¦ä¸²', { åŸå§‹: checkOutTime, å¤„ç†å: timeString });
            }
        } else if (checkOutTime && checkOutTime instanceof Date) {
            // å¦‚æœæ˜¯ Date å¯¹è±¡ï¼Œæå–æ—¶é—´éƒ¨åˆ†
            timeString = checkOutTime.toTimeString().slice(0, 5);
        }

        // å¤„ç†åŠ ç­æ—¶é—´
        let overtime = 0;
        if (overtimeHours !== undefined && overtimeHours !== null) {
            overtime = Math.max(0, parseFloat(overtimeHours) || 0);
        }

        const record = {
            date: dateField, // åº”è¯¥å·²ç»æ˜¯ YYYY-MM-DD æ ¼å¼
            time: timeString,
            overtime: overtime,
            synced: true
        };

        this.debug('å¤„ç†åçš„è®°å½•', { 
            åŸå§‹: item, 
            å¤„ç†å: record,
            å­—æ®µæ˜ å°„: { 
                date: dateField, 
                checkOut: checkOutTime, 
                overtime: overtimeHours 
            }
        });
        return record;
    }).filter(Boolean);

    this.debug('è½¬æ¢åçš„æœåŠ¡å™¨è®°å½•', serverRecords);

    // åˆå¹¶é€»è¾‘ï¼šæ›´æ–°æˆ–æ·»åŠ è®°å½•
    serverRecords.forEach(serverRecord => {
        const existingIndex = this.workHistory.findIndex(localRecord => localRecord.date === serverRecord.date);

        if (existingIndex === -1) {
            // æ·»åŠ æ–°è®°å½•
            this.workHistory.push(serverRecord);
            this.debug('æ·»åŠ æ–°è®°å½•', serverRecord);
        } else {
            // æ›´æ–°ç°æœ‰è®°å½•
            const oldRecord = { ...this.workHistory[existingIndex] };
            this.workHistory[existingIndex] = { 
                ...this.workHistory[existingIndex], 
                ...serverRecord
            };
            this.debug('æ›´æ–°ç°æœ‰è®°å½•', { æ—§: oldRecord, æ–°: this.workHistory[existingIndex] });
        }
    });

    // æŒ‰æ—¥æœŸå€’åºæ’åˆ—
    this.workHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
    localStorage.setItem('workHistory', JSON.stringify(this.workHistory));
    this.debug('åˆå¹¶åçš„å†å²è®°å½•', this.workHistory);
}
            timeToMinutes(timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            }

            startClock() {
                let lastDate = new Date().toDateString();
                setInterval(() => {
                    const now = new Date();
                    const currentDate = now.toDateString();
                    
                    if (currentDate !== lastDate) {
                        lastDate = currentDate;
                        this.updateDisplay();
                        this.showNotification('æ–°çš„ä¸€å¤©å¼€å§‹ï¼Œé¢„è®¡ä¸‹ç­æ—¶é—´å·²æ›´æ–°ï¼');
                    }
                    
                    const timeString = now.toLocaleTimeString('zh-CN', {
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    document.getElementById('currentTime').textContent = `å½“å‰æ—¶é—´: ${timeString}`;
                }, 1000);
            }

calculateExpectedOffTime() {
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();

    // è·å–æœ¬æœˆçš„å·¥ä½œè®°å½•
    const monthlyRecords = this.workHistory.filter(record => {
        const recordDate = new Date(record.date);
        return recordDate.getMonth() === currentMonth &&
               recordDate.getFullYear() === currentYear;
    });

    // è®¡ç®—æœ¬æœˆå·²å®Œæˆçš„åŠ ç­æ—¶é—´
    const monthlyOvertime = monthlyRecords.reduce((total, record) => total + record.overtime, 0);

    // è®¡ç®—å‰©ä½™éœ€è¦çš„åŠ ç­æ—¶é—´
    const remainingOvertime = Math.max(0, this.monthlyTarget - monthlyOvertime);

    // è®¡ç®—å‰©ä½™å·¥ä½œæ—¥ï¼ˆåŒ…æ‹¬ä»Šå¤©ï¼‰
    const remainingWorkDays = this.getRemainingWorkDays(currentYear, currentMonth, today.getDate());

    // è®¡ç®—æ¯æ—¥éœ€è¦çš„åŠ ç­æ—¶é—´
    const dailyOvertimeNeeded = remainingWorkDays > 0 ? remainingOvertime / remainingWorkDays : 0;

    // è®¡ç®—é¢„è®¡ä¸‹ç­æ—¶é—´
    const [normalHour, normalMinute] = this.normalOffTime.split(':').map(Number);
    
    // è¯¦ç»†è®¡ç®—è¿‡ç¨‹
    const dailyOvertimeMinutes = dailyOvertimeNeeded * 60; // æ¯æ—¥åŠ ç­åˆ†é’Ÿæ•°
    const totalMinutes = normalHour * 60 + normalMinute + dailyOvertimeMinutes;
    
    const expectedHour = Math.floor(totalMinutes / 60);
    const expectedMinute = Math.round(totalMinutes % 60); // å››èˆäº”å…¥åˆ°æœ€è¿‘çš„åˆ†é’Ÿ

    // è®¡ç®—æœ¬æœˆå¹³å‡ä¸‹ç­æ—¶é—´
    const averageOffTime = this.calculateAverageOffTime(monthlyRecords);

    // è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
    this.debug('=== é¢„è®¡ä¸‹ç­æ—¶é—´è¯¦ç»†è®¡ç®— ===', {
        åŸºç¡€æ•°æ®: {
            æœ¬æœˆç›®æ ‡åŠ ç­å°æ—¶: this.monthlyTarget,
            æœ¬æœˆå·²å®ŒæˆåŠ ç­å°æ—¶: monthlyOvertime,
            å‰©ä½™éœ€è¦åŠ ç­å°æ—¶: remainingOvertime,
            å‰©ä½™å·¥ä½œæ—¥: remainingWorkDays,
            æ­£å¸¸ä¸‹ç­æ—¶é—´: this.normalOffTime
        },
        è®¡ç®—è¿‡ç¨‹: {
            æ¯æ—¥éœ€è¦åŠ ç­å°æ—¶: dailyOvertimeNeeded,
            æ¯æ—¥éœ€è¦åŠ ç­åˆ†é’Ÿ: dailyOvertimeMinutes,
            æ­£å¸¸ä¸‹ç­åˆ†é’Ÿæ•°: normalHour * 60 + normalMinute,
            æ€»åˆ†é’Ÿæ•°: totalMinutes,
            è®¡ç®—å‡ºçš„å°æ—¶: expectedHour,
            è®¡ç®—å‡ºçš„åˆ†é’Ÿ: expectedMinute
        },
        æœ€ç»ˆç»“æœ: {
            é¢„è®¡ä¸‹ç­æ—¶é—´: `${expectedHour.toString().padStart(2, '0')}:${expectedMinute.toString().padStart(2, '0')}`
        }
    });

    return {
        time: `${expectedHour.toString().padStart(2, '0')}:${expectedMinute.toString().padStart(2, '0')}`,
        monthlyOvertime: monthlyOvertime,
        remainingOvertime: remainingOvertime,
        dailyOvertime: dailyOvertimeNeeded,
        workDaysLeft: remainingWorkDays,
        averageOffTime: averageOffTime
    };
}

            calculateAverageOffTime(records) {
    if (records.length === 0) {
        return this.normalOffTime; // å¦‚æœæ²¡æœ‰è®°å½•ï¼Œè¿”å›æ­£å¸¸ä¸‹ç­æ—¶é—´
    }

    // è®¡ç®—æ‰€æœ‰è®°å½•çš„ä¸‹ç­æ—¶é—´å¹³å‡å€¼
    let totalMinutes = 0;
    let validRecords = 0;

    records.forEach(record => {
        if (record.time && record.time !== '00:00') {
            const timeParts = record.time.split(':');
            if (timeParts.length >= 2) {
                const hour = parseInt(timeParts[0], 10);
                const minute = parseInt(timeParts[1], 10);
                
                if (!isNaN(hour) && !isNaN(minute) && hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {
                    totalMinutes += hour * 60 + minute;
                    validRecords++;
                    this.debug(`æœ‰æ•ˆè®°å½•: ${record.date} ${record.time}`);
                }
            }
        }
    });

    if (validRecords === 0) {
        this.debug('æ²¡æœ‰æœ‰æ•ˆçš„ä¸‹ç­æ—¶é—´è®°å½•ï¼Œä½¿ç”¨æ­£å¸¸ä¸‹ç­æ—¶é—´');
        return this.normalOffTime;
    }

    const averageMinutes = Math.round(totalMinutes / validRecords);
    const averageHour = Math.floor(averageMinutes / 60);
    const averageMinute = averageMinutes % 60;

    const result = `${averageHour.toString().padStart(2, '0')}:${averageMinute.toString().padStart(2, '0')}`;
    
    this.debug('å¹³å‡ä¸‹ç­æ—¶é—´è®¡ç®—', {
        æœ‰æ•ˆè®°å½•æ•°: validRecords,
        æ€»åˆ†é’Ÿæ•°: totalMinutes,
        å¹³å‡åˆ†é’Ÿæ•°: averageMinutes,
        å¹³å‡ä¸‹ç­æ—¶é—´: result
    });

    return result;
}

            getWorkDaysInMonth(year, month) {
                const date = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0).getDate();
                let workDays = 0;
                
                for (let day = 1; day <= lastDay; day++) {
                    date.setDate(day);
                    const dayOfWeek = date.getDay();
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                        workDays++;
                    }
                }
                
                return workDays;
            }

         getRemainingWorkDays(year, month, currentDay) {
    const today = new Date(year, month, currentDay);
    const lastDay = new Date(year, month + 1, 0).getDate();
    let workDays = 0;
    
    // ä»ä»Šå¤©å¼€å§‹è®¡ç®—åˆ°æœˆåº•çš„å·¥ä½œæ—¥
    for (let day = currentDay; day <= lastDay; day++) {
        const checkDate = new Date(year, month, day);
        const dayOfWeek = checkDate.getDay();
        // æ’é™¤å‘¨å…­(6)å’Œå‘¨æ—¥(0)
        if (dayOfWeek !== 0 && dayOfWeek !== 6) {
            workDays++;
        }
    }
    
    this.debug(`å‰©ä½™å·¥ä½œæ—¥è®¡ç®—: ä»${currentDay}æ—¥åˆ°${lastDay}æ—¥ï¼Œå…±${workDays}ä¸ªå·¥ä½œæ—¥`);
    return workDays;
}

     updateDisplay() {
    let calculation;

    if (this.serverStats) {
        this.debug('=== ä½¿ç”¨æœåŠ¡å™¨ç»Ÿè®¡æ•°æ® ===', this.serverStats);

        // ä»æœåŠ¡å™¨æ•°æ®è®¡ç®—é¢„è®¡ä¸‹ç­æ—¶é—´
        const monthOvertime = Math.max(0, parseFloat(this.serverStats.monthOvertime || 0));
        const remainingOvertime = Math.max(0, parseFloat(this.serverStats.remainingOvertime || this.monthlyTarget));
        const workDaysLeft = parseInt(this.serverStats.workDaysLeft || 0);
        
        // é‡æ–°è®¡ç®—é¢„è®¡ä¸‹ç­æ—¶é—´ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ avgLeaveTime
        const dailyOvertimeNeeded = workDaysLeft > 0 ? remainingOvertime / workDaysLeft : 0;
        const [normalHour, normalMinute] = this.normalOffTime.split(':').map(Number);
        const dailyOvertimeMinutes = dailyOvertimeNeeded * 60;
        const totalMinutes = normalHour * 60 + normalMinute + dailyOvertimeMinutes;
        const expectedHour = Math.floor(totalMinutes / 60);
        const expectedMinute = Math.round(totalMinutes % 60);
        
        const calculatedTime = `${expectedHour.toString().padStart(2, '0')}:${expectedMinute.toString().padStart(2, '0')}`;

        this.debug('=== æœåŠ¡å™¨æ•°æ®é‡æ–°è®¡ç®— ===', {
            æœåŠ¡å™¨avgLeaveTime: this.serverStats.avgLeaveTime,
            é‡æ–°è®¡ç®—çš„æ—¶é—´: calculatedTime,
            è®¡ç®—ä¾æ®: {
                å‰©ä½™åŠ ç­: remainingOvertime,
                å‰©ä½™å·¥ä½œæ—¥: workDaysLeft,
                æ¯æ—¥éœ€åŠ ç­: dailyOvertimeNeeded,
                æ¯æ—¥åŠ ç­åˆ†é’Ÿ: dailyOvertimeMinutes
            }
        });

        calculation = {
            time: calculatedTime, // ä½¿ç”¨é‡æ–°è®¡ç®—çš„æ—¶é—´ï¼Œè€Œä¸æ˜¯æœåŠ¡å™¨çš„ avgLeaveTime
            monthlyOvertime: monthOvertime,
            remainingOvertime: remainingOvertime,
            dailyOvertime: dailyOvertimeNeeded,
            workDaysLeft: workDaysLeft,
            averageOffTime: this.serverStats.avgLeaveTime || '18:00' // å¹³å‡ä¸‹ç­æ—¶é—´ä»ä½¿ç”¨æœåŠ¡å™¨æ•°æ®
        };
    } else {
        this.debug('=== ä½¿ç”¨æœ¬åœ°è®¡ç®— ===');
        calculation = this.calculateExpectedOffTime();

        // ç¡®ä¿æœ¬åœ°è®¡ç®—ç»“æœä¸ä¸ºè´Ÿæ•°
        calculation.monthlyOvertime = Math.max(0, calculation.monthlyOvertime);
        calculation.remainingOvertime = Math.max(0, calculation.remainingOvertime);
        calculation.dailyOvertime = Math.max(0, calculation.dailyOvertime);
    }

    this.debug('=== æœ€ç»ˆæ˜¾ç¤ºæ•°æ® ===', calculation);

    // æ›´æ–°ç•Œé¢æ˜¾ç¤º
    document.getElementById('expectedTime').textContent = calculation.time;
    document.getElementById('monthlyOvertime').textContent = calculation.monthlyOvertime.toFixed(1);
    document.getElementById('remainingOvertime').textContent = calculation.remainingOvertime.toFixed(1);
    document.getElementById('workDaysLeft').textContent = calculation.workDaysLeft;
    document.getElementById('averageOffTime').textContent = calculation.averageOffTime;

    // æ›´æ–°çŠ¶æ€æ–‡æœ¬
    let statusText;
    if (calculation.dailyOvertime > 0) {
        const workDaysInfo = calculation.workDaysLeft ? `ï¼ˆå‰©ä½™${calculation.workDaysLeft}ä¸ªå·¥ä½œæ—¥ï¼‰` : '';
        statusText = `éœ€åŠ ç­ ${calculation.dailyOvertime.toFixed(1)} å°æ—¶/å¤© ${workDaysInfo}`;
    } else {
        statusText = 'å‡†æ—¶ä¸‹ç­';
    }
    document.getElementById('statusText').textContent = statusText;

    this.updateHistory();
}
     updateHistory() {
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';
    
    const recentHistory = this.workHistory.slice(0, 5); // ç”¨ slice(0, 5) è·å–æœ€æ–°çš„5æ¡
    
    recentHistory.forEach(record => {
        const item = document.createElement('div');
        item.className = 'history-item';
        const syncIcon = record.synced ? 'âœ“' : 'âŸ³';
        const syncClass = record.synced ? 'synced' : 'pending';
        
        // -- ä¿®æ­£ç‚¹ 5: æ˜¾ç¤ºæ—¶æ ¼å¼åŒ–æ—¥æœŸ --
        const displayDate = new Date(record.date).toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });

        item.innerHTML = `
            <span>${record.date.replace(/-/g, '/')}</span>
            <span>${record.time} (${record.overtime > 0 ? '+' : ''}${record.overtime.toFixed(1)}h) <span class="${syncClass}">${syncIcon}</span></span>
        `;
        historyList.appendChild(item);
    });
    
    if (recentHistory.length === 0) {
        historyList.innerHTML = '<div style="text-align: center; color: #999;">æš‚æ— æ‰“å¡è®°å½•</div>';
    }
}
        
async clockOut() {
    const now = new Date();
    const timeString = now.toTimeString().slice(0, 5);
    const dateString = getISODateString(now); 

    const todayRecord = this.workHistory.find(record => record.date === dateString);
    if (todayRecord) {
        this.showNotification('ä»Šå¤©å·²ç»æ‰“è¿‡å¡äº†ï¼', 'warning');
        return;
    }

    const [normalHour, normalMinute] = this.normalOffTime.split(':').map(Number);
    const [currentHour, currentMinute] = timeString.split(':').map(Number);

    const normalMinutes = normalHour * 60 + normalMinute;
    const currentMinutes = currentHour * 60 + currentMinute;
    const overtimeMinutes = currentMinutes - normalMinutes;
    const overtimeHours = Math.max(0, overtimeMinutes / 60);

    const record = {
        date: dateString,
        time: timeString,
        overtime: parseFloat(overtimeHours.toFixed(2)),
        synced: false
    };

    this.debug('åˆ›å»ºæ‰“å¡è®°å½•', record);

    this.workHistory.push(record);
    this.workHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
    localStorage.setItem('workHistory', JSON.stringify(this.workHistory));

    this.showNotification('æ­£åœ¨åŒæ­¥æ•°æ®...', 'info');

    const syncSuccess = await this.writeToGoogleSheets(record);
    if (syncSuccess) {
        record.synced = true;
        localStorage.setItem('workHistory', JSON.stringify(this.workHistory));
        setTimeout(async () => {
            await this.loadFromServer();
        }, 1000);
    } else {
        this.updateDisplay();
    }

    this.showNotification('æ‰“å¡æˆåŠŸï¼' + (syncSuccess ? 'æ•°æ®å·²åŒæ­¥' : 'æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°'),
                       syncSuccess ? 'success' : 'warning');
}

async writeToGoogleSheets(record) {
    if (!this.gasUrl) {
        this.debug('æœªè®¾ç½®Google Apps Script URL');
        return false;
    }

    try {
        // æ„å»ºè¦å‘é€çš„æ•°æ®ï¼Œç¡®ä¿å­—æ®µåä¸è¡¨å¤´ä¸€è‡´
        const payload = {
            action: 'addRecord',
            Date: record.date,                    // å¯¹åº” Date åˆ—
            CheckIn: '09:00:00',                 // å¯¹åº” CheckIn åˆ—
            CheckOut: record.time + ':00',       // å¯¹åº” CheckOut åˆ— (æ·»åŠ ç§’æ•°)
            OvertimeHours: record.overtime       // å¯¹åº” OvertimeHours åˆ—
        };

        this.debug('å‘é€åˆ°GASçš„æ•°æ®', payload);

        // ä½¿ç”¨æ”¹è¿›çš„æäº¤æ–¹æ³•
        const success = await this.submitToGAS(payload);
        
        if (success) {
            this.debug('æ•°æ®å†™å…¥æˆåŠŸ');
            return true;
        } else {
            this.debug('æ•°æ®å†™å…¥å¤±è´¥');
            return false;
        }

    } catch (error) {
        this.debug('å†™å…¥Google Sheetså¤±è´¥', error);
        console.error('å†™å…¥Google Sheetså¤±è´¥:', error);
        return false;
    }
}
async submitToGASFallback(data) {
    return new Promise((resolve) => {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = this.gasUrl;
        form.target = 'gas_frame'; // ä½¿ç”¨éšè—iframeè€Œä¸æ˜¯æ–°çª—å£
        form.style.display = 'none';

        // ä¸ºæ¯ä¸ªå­—æ®µåˆ›å»ºinput
        Object.keys(data).forEach(key => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = data[key];
            form.appendChild(input);
        });

        // åˆ›å»ºæˆ–ä½¿ç”¨ç°æœ‰çš„éšè—iframe
        let iframe = document.getElementById('gas_frame');
        if (!iframe) {
            iframe = document.createElement('iframe');
            iframe.id = 'gas_frame';
            iframe.name = 'gas_frame';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
        }

        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);

        this.debug('è¡¨å•å·²æäº¤åˆ°GAS', data);

        // ç­‰å¾…ä¸€æ®µæ—¶é—´åå‡è®¾æˆåŠŸ
        setTimeout(() => {
            resolve(true);
        }, 2000);
    });
}
async submitToGAS(data) {
    try {
        // æ–¹æ³•1: ä½¿ç”¨ fetch POST è¯·æ±‚ (ä¼˜å…ˆä½¿ç”¨)
        const formData = new FormData();
        
        // å°†æ•°æ®ä½œä¸ºè¡¨å•å­—æ®µå‘é€
        Object.keys(data).forEach(key => {
            formData.append(key, data[key]);
        });

        const response = await fetch(this.gasUrl, {
            method: 'POST',
            body: formData,
            mode: 'no-cors' // å¯¹äºGASå¿…é¡»ä½¿ç”¨no-cors
        });

        this.debug('POSTè¯·æ±‚å·²å‘é€', data);
        
        // ç”±äºno-corsæ¨¡å¼æ— æ³•è¯»å–å“åº”ï¼Œæˆ‘ä»¬å‡è®¾è¯·æ±‚æˆåŠŸ
        // å¯ä»¥é€šè¿‡åç»­çš„æ•°æ®åˆ·æ–°æ¥éªŒè¯æ˜¯å¦çœŸçš„æˆåŠŸ
        return true;

    } catch (error) {
        this.debug('POSTè¯·æ±‚å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•', error);
        
        // æ–¹æ³•2: å¤‡ç”¨çš„éšè—è¡¨å•æäº¤æ–¹æ³•
        return this.submitToGASFallback(data);
    }
}
            calculateWorkMinutes(checkInTime, checkOutTime) {
                const [inHour, inMinute] = checkInTime.split(':').map(Number);
                const [outHour, outMinute] = checkOutTime.split(':').map(Number);
                
                const inMinutes = inHour * 60 + inMinute;
                const outMinutes = outHour * 60 + outMinute;
                
                return Math.max(0, outMinutes - inMinutes);
            }

            showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }

            loadSettings() {
                const savedNormalTime = localStorage.getItem('normalOffTime');
                const savedTarget = localStorage.getItem('monthlyTarget');
                const savedUrl = localStorage.getItem('gasUrl');
                
                if (savedNormalTime) {
                    this.normalOffTime = savedNormalTime;
                    document.getElementById('normalOffTime').value = savedNormalTime;
                }
                
                if (savedTarget) {
                    this.monthlyTarget = parseInt(savedTarget);
                    document.getElementById('monthlyTarget').value = savedTarget;
                }
                
                if (savedUrl) {
                    this.gasUrl = savedUrl;
                    document.getElementById('gasUrl').value = savedUrl;
                }
            }

            async saveSettings() {
                const normalOffTime = document.getElementById('normalOffTime').value;
                const monthlyTarget = document.getElementById('monthlyTarget').value;
                const gasUrl = document.getElementById('gasUrl').value;
                
                this.normalOffTime = normalOffTime;
                this.monthlyTarget = parseInt(monthlyTarget);
                this.gasUrl = gasUrl;
                
                localStorage.setItem('normalOffTime', normalOffTime);
                localStorage.setItem('monthlyTarget', monthlyTarget);
                localStorage.setItem('gasUrl', gasUrl);
                
                // é‡æ–°ä»æœåŠ¡å™¨åŠ è½½æ•°æ®
                if (gasUrl) {
                    await this.loadFromServer();
                } else {
                    this.updateDisplay();
                }
                
                this.showNotification('è®¾ç½®å·²ä¿å­˜ï¼');
            }
        }

        // å…¨å±€å‡½æ•°
        let tracker;

        async function clockOut() {
            await tracker.clockOut();
        }

        function toggleSettings() {
            const settingsSection = document.getElementById('settingsSection');
            settingsSection.style.display = 
                settingsSection.style.display === 'none' ? 'block' : 'none';
        }

        async function saveSettings() {
            await tracker.saveSettings();
        }

        async function refreshData() {
            if (!tracker.gasUrl) {
                tracker.showNotification('è¯·å…ˆè®¾ç½®Google Apps Script URL', 'warning');
                return;
            }
            tracker.showNotification('æ­£åœ¨åˆ·æ–°æ•°æ®...', 'info');
            await tracker.loadFromServer();
        }

        // æµ‹è¯•è¿æ¥åŠŸèƒ½
      async function testConnection() {
    if (!tracker.gasUrl) {
        tracker.showNotification('è¯·å…ˆè®¾ç½®Google Apps Script URL', 'warning');
        return;
    }

    tracker.showNotification('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');
    
    try {
        // å°è¯•JSONPæ–¹å¼æµ‹è¯•
        const testData = await tracker.fetchWithJSONP();
        tracker.debug('è¿æ¥æµ‹è¯•ç»“æœ', testData);
        
        if (testData && !testData.error) {
            tracker.showNotification('è¿æ¥æµ‹è¯•æˆåŠŸï¼æœåŠ¡å™¨å“åº”æ­£å¸¸', 'success');
        } else if (testData && testData.error) {
            tracker.showNotification(`è¿æ¥æˆåŠŸä½†æœåŠ¡å™¨è¿”å›é”™è¯¯: ${testData.error}`, 'warning');
        } else {
            tracker.showNotification('è¿æ¥æˆåŠŸä½†æœåŠ¡å™¨è¿”å›ç©ºæ•°æ®ï¼Œè¯·æ£€æŸ¥GASä»£ç ', 'warning');
        }
    } catch (error) {
        tracker.debug('è¿æ¥æµ‹è¯•å¤±è´¥', error);
        tracker.showNotification(`è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
    }
}

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', async () => {
            tracker = new OvertimeTracker();

            // é¡µé¢åŠ è½½å®Œæˆåç«‹å³å°è¯•è·å–æ•°æ®
            if (tracker.gasUrl) {
                tracker.showNotification('æ­£åœ¨è‡ªåŠ¨åŠ è½½æ•°æ®...', 'info');
                await tracker.loadFromServer();
            } else {
                tracker.showNotification('è¯·åœ¨è®¾ç½®ä¸­é…ç½®Google Apps Script URLä»¥è‡ªåŠ¨åŒæ­¥æ•°æ®', 'warning');
            }

            // é¡µé¢è·å¾—ç„¦ç‚¹æ—¶æ›´æ–°æ•°æ®ï¼ˆä»å…¶ä»–æ ‡ç­¾é¡µåˆ‡æ¢å›æ¥æ—¶ï¼‰
            window.addEventListener('focus', async () => {
                if (tracker.gasUrl) {
                    await tracker.loadFromServer(); // é‡æ–°ä»æœåŠ¡å™¨åŠ è½½
                }
            });

            // æ¯30åˆ†é’Ÿè‡ªåŠ¨æ›´æ–°ä¸€æ¬¡æ•°æ®ï¼ˆæ›´é¢‘ç¹çš„æ›´æ–°ï¼‰
            setInterval(async () => {
                if (tracker.gasUrl) {
                    await tracker.loadFromServer();
                }
            }, 1800000); // 30åˆ†é’Ÿ = 1800000æ¯«ç§’
        });

    </script>
</body>
</html>